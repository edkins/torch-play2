<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<script>
"use strict";

let available_models = [];
let selected_model = undefined;
let selected_model_details = undefined;

async function load() {
	const response = await fetch('/api/model');
	available_models = (await response.json()).items;
	redraw_side_panel();
}

async function refetch_model() {
	if (selected_model === undefined) {
		selected_model_details = undefined;
		return;
	}
	const response = await fetch(`/api/model/${selected_model}`);
	selected_model_details = (await response.json()).data;
	redraw_main_panel();
}

function redraw_side_panel() {
	const panel = document.getElementById('model-listing');
	panel.innerHTML = '';
	for (let item of available_models) {
		const div = document.createElement('div');
		const accuracy = (item.accuracy * 100).toFixed(1);
		div.textContent = `${item.name} - ${accuracy}%`;
		div.onclick = () => {
			selected_model = item.name;
			redraw_side_panel();
			return refetch_model();
		};
		if (item.name === selected_model) {
			div.classList.add('selected');
		}
		panel.appendChild(div);
	}
}

function redraw_main_panel() {
	const panel = document.getElementById('main-panel');
	panel.innerHTML = '';
	if (selected_model_details === undefined) {
		return;
	}
	const dropdown = document.createElement('select');
	dropdown.id = 'layer_dropdown';
	for (let i = 0; i < selected_model_details.layers.length; i++) {
		const layer = selected_model_details.layers[i];
		const option = document.createElement('option');
		option.value = `${i}`;
		option.textContent = `Layer ${i} - [${shape_to_string(layer.shape)}] ${layer.type}`;
		dropdown.appendChild(option);
	}
	panel.appendChild(dropdown);
	const ndropdown = document.createElement('select');
	ndropdown.id = 'neuron_dropdown';
	dropdown.onchange = repopulate_neuron_dropdown;
	panel.appendChild(ndropdown);
	repopulate_neuron_dropdown();
}

function product(list) {
	let result = 1;
	for (let x of list) {
		result *= x;
	}
	return result;
}

function shape_to_string(shape) {
	return shape.join('x');
}

function repopulate_neuron_dropdown() {
	const dropdown = document.getElementById('neuron_dropdown');
	const selected_layer = parseInt(document.getElementById('layer_dropdown').value);
	const layer = selected_model_details.layers[selected_layer];
	const count = product(layer.shape);
	dropdown.innerHTML = '';
	for (let i = 0; i < count; i++) {
		const option = document.createElement('option');
		option.value = `${i}`;
		option.textContent = `Neuron ${i}`;
		dropdown.appendChild(option);
	}
}

window.onload = load;
</script>
<style>

.main {
	display: grid;
	grid-template-columns: 1fr 3fr;
	grid-auto-rows: minmax(600px, auto);
}

.left-panel {
	white-space: pre;
	background: #eee;
}

.left-panel .selected {
	background: #ccc;
}

</style>
</head>
<body>
	<div class="main">
		<div class="left-panel" id="model-listing"></div>
		<div id="main-panel"></div>
	</div>
</body>
</html>
